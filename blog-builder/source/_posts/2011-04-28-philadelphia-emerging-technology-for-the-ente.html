---
layout: post
title: Yehuda Katz at Philly ETE - Rails 3.1 Engines
tags: []
status: publish
type: post
published: true
meta: {}
---
<p><span style="font-size: medium;">Rails 3.1 Engines</span></p><p>Using an engine in Rails 3.0.x is functionally the same as copying the engine code directly into your app. There's one giant global namespace for routing and helpers. This leads to ugly name mangling (devise_engine_login_helper) and routing collistions (match "login").&nbsp;</p><div><span style="font-size: medium;">Detour into Rack</span></div><p /><div>Rack apps take a request hash (env) and return a response of [status_code, headers, response_body].</div><p /><div>Rails 3 router is Rack middleware, Rack apps</div><p /><div>Each middleware piece considers the thing above it "the server", the thing below it as "the app"</div><p>Rails router can route to any rack app, seamlessly route to&nbsp;</p><p>&nbsp;</p><div>* Router chooses which Rack endpoint to send each request to</div><div>** match "/posts/*path" =&gt; SinatraApp || match "/users" =&gt; "posts#index" (translates to the controller action)</div><p /><p>&nbsp;</p><p>Some stuff that I probably should have known, but didn't</p><p>Rails 3 router just points to Rack endpoints</p><p>Translates "posts#index" to PostsController.action(:index)</p><p>PostsController.action(:index) returns a Rack app</p><p>&nbsp;</p><p><span style="font-size: medium;">Mountable Engines in Rails 3.1 (currently in Rails edge)</span></p><p>Piotr Sarnacki developed engines for 3.1 for GSOC. His blog has a bunch of posts about Rails engines,&nbsp;<a href="http://piotrsarnacki.com/2010/12/21/mountable-apps-tutorial/  ">building an engine</a>, new&nbsp;<a href="http://piotrsarnacki.com/2010/09/14/mountable-engines/">features of engines</a>, and some of the&nbsp;<a href="http://piotrsarnacki.com/2010/09/06/rsoc-status-namespacing-engines/">reasoning behind the engines changes</a>.</p><p /><p /><div><div>** API called mount ! - mount SinatraApp =&gt; "/posts"</div><div>** This has all worked since Rails 3</div><div>** Rails 3.1&nbsp;</div><div>*** Use mount</div><div>*** Engines are now Rack apps</div><div>** General rule - mount Rack app under a specific url</div><div>** Helpers!</div><div>*** helper: devise.login_path</div><div>*** helper :all</div><div>*** only include helpers in the current namespace</div><div>** Register a namespace for the namespace for the App</div><div>*** register Blog, then Blog::helpers belong to the Blog app (?)</div><div>** Migrations</div><div>*** rake railties:copy_migrations</div><div>**** Copied over to record history</div><div>**** Timestamps are updated to reflect what happened</div><div>*** migrations are a history of applied changes</div><div>** Assets</div><div>*** served through Rails server</div><div>*** Should be easy to get working without configuration</div><div>*** Works</div><div>** Rails 3.1 Sprockets</div><div>*** Compilation pipeline</div><div>*** Top level concern - template handling,&nbsp;</div><div>*** amping up cache_javascript :all</div><div>*** could be a whole new talk</div><div>** Engines can have assets</div><div>** SCSS and CoffeeScript</div><div>*** SCSS - opt-in when you want to, avoid CSS3 vendor hacks</div><div>*** CoffeeScript application.js.coffee</div><div>*** //= require('something')</div><div>**** That's a sprockets directive, see sprockets site</div><div>*** CoffeeScript - point to something cool that exists</div><div>** //= require("rails_admin/login");</div><div>*** SCSS can @import Engine Files</div><div>@import "rails_admin/mixins.scss";</div><div>** rails plugin new blog --mountable &lt;=== build an engine</div><div>#+BEGIN_SRC ruby</div><div>module Blog</div><div>class Engine &lt; Rails::Engine</div><div>isolate_namespace Blog # where to look for helpers</div><div>end</div><div>end</div><div>#+END_SRC</div><div>** rails g scaffold post title:string&nbsp;</div><div>*** will detect that you're in an engine that's inside a namespace</div><div>*** Do all the scaffoldy stuff inside of a namespace Blog::Post</div><div>** rails server #works inside of an engine</div><div>*** Runs against dummy application that has loaded the engine inside of it</div><div>** piotrsarnacki.com ALL THE DETAILS !!!</div><div>*** What should params look like (they look the same)</div><div>** Questions</div><div>*** Multiple db connection not supported by Engines</div><div>*** Take a look at Octopus (db sharding)</div><div>**** Look at adding Engine support (use this db for this namespace)</div><div>** Assets - what's the heroku problem? Look up the heroku problem</div><div>*** rake deploy (does that exist?)</div><div>** Devise will define the API -- Devise for authentication</div></div><p /><p>&nbsp;</p>
